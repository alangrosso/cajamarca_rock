---
title: "**CAJAMARCA ROCK**"  

subtitle:  <font size="4">Primera Edición</font> 
##<h1>Primera Edición</h1>
## "Primera Edición"

#author: '**Alan Grosso Romo** <alangrosso@gmail.com>' # Autor:
#author: " <br> 
#  **Autor**: Alan Grosso <br> 
#  **Contacto**: <alangrosso@gmail.com> |   #[Instagram](https://www.instagram.com/alangrosso) |   #[LinkedIn](https://www.linkedin.com/in/alangrosso) 
#  <br>
#  " 

date: "Septiembre 2021"
#date: "**Fecha de publicación**: Septiembre 2021"
#date: '**Marzo 2021**' # Fecha: "`r format(Sys.time(), '%d %B %Y')`"

# keywords: 'markdown, formato, trucos'

# output: pdf_document

output:

# la salida predefinida es html
  html_document:

# Paged printing
    df_print: kable

# ver/ocultar los trozos de código
    #code_download: true  # si incluimos un botón para bajar el código o no
    #code_folding: hide   # para mostrar o esconder los chunk de codigo

# tabla de contenido
    #number_sections: yes   # numera los titulos
    toc: TRUE               # incluye o no el indice
    toc_float: TRUE         # incluye o no indice flotante (a la izquierda)
    collapse: TRUE      # que se escondan los títulos
    smooth_scroll: TRUE  # scroll en TOC

# formato  estilo
    theme: "spacelab"    # especifica el tema Bootstrap
    # https://www.datadreaming.org/post/r-markdown-theme-gallery/
    highlight: kate      # resaltado de sintaxis #
    #self_contained: false    # salida fichero autocontenido

# formato de figuras
    fig_width: 7         # ancho de las figuras por defecto
    fig_height: 5        # alto de las figuras
    fig_caption: TRUE    # titulo de figura

# advanced customization of output by including additional HTML content
    # includes:
    #  in_header: <img src="T:/BD_SCORE/Refinanciados/R/LogosCDK/logo-cdk-2.jpg" \>
    #  before_body: doc_prefix.html
    # after_body: doc_suffix.html
    # cover-image: "images/cover.png" 



# output:
#   html_document
      #ioslides_presentation
      #slidy_presentation
      #powerpoint_presentation # error 
      #beamer_presentation # error 

#output:
#  prettydoc::html_pretty:
#    theme: hpstr  
#    highlight: vignette

---

<script>

$(document).ready(function() {$head = $('#header'); $head.prepend('<img src=\"https://raw.githubusercontent.com/alangrosso/dft_support/master/logo%20dft%201.png\" style=\"float: right; width: 100px; height: 100px\"/>')});

</script>


```{r warning= F, message= F, echo=FALSE}
##======= Código logo local

# <script>
# 
#   $(document).ready(function() {$head = $('#header'); $head.prepend('<img src=\"Imagenes/logo_dft_1.png" style=\"float: right; width: 100px; height:  100px\"/>')});
# 
# </script>

##======= Insertar imagen desde github

# raw.githubusercontent.com/username/repo-name/branch-name/path
# GitHub.com/username/repo-name/directory-path/blob/branch-name/filename

# ![](https://raw.githubusercontent.com/alangrosso/dft_support/master/logo%20dft%201.png){width='20px'}



```



```{r warning= F, message= F, echo=FALSE}
#knitr::opts_chunk$set(echo = FALSE)
load("D:/Proyectos/Proyecto Musica - 02 Cajamarca Rock/20202512/R/Cajamarca_Rock_20202512.RData")
```

```{r warning= F, message= F, echo=FALSE}
library(tidyverse)
library(data.table)

library(corrplot)

#library(caret)

library(knitr)
library(kableExtra)

library(Rspotify)

library(prettydoc)

library(wordcloud)
library(wordcloud2)

library(patchwork)

library(viridis)

library(hrbrthemes)

library(grid)
library(gridExtra)

library(rpart)
library(rpart.plot)

library(fmsb)
library(ggradar)

```


***
***

## **[1] Introducción**

***
***

Este es un análisis sobre las bandas de rock de Cajamarca (Perú) en uno de los servicios de transmisión de música más usado (**Spotify**), que da acceso a millones de canciones y otros contenidos de artistas de todo el mundo.

Teniendo como referencia la playlist **[Cajamarca Rock](https://open.spotify.com/playlist/0NEpA7QS9DDRHa3JsAtdcd?si=da2c37c0d7ea4dcd)**,  y la información disponible en Spotify al 25.12.2020, se obtienen los datos necesarios que permitan mostrar los géneros musicales, características de las canciones, y perfiles de los artistas.

![](https://raw.githubusercontent.com/alangrosso/cajamarca_rock/master/Imagenes/CajamarcaRockPlayList_20210830.PNG){ width=67% }

```{r warning= F, message= F, echo=FALSE}
# 

# ![](D:/Proyectos/Proyecto Musica - 02 Cajamarca Rock/20202512/R/Imagenes/CajamarcaRockPlayList_20210830.png){ width=60% }

# El análisis inicia con la información descriptiva de los artistas, para luego determinar algunos  segmentos de acuerdo a sus características. 

# ![](D:/Proyectos/Proyecto Musica - 02 Cajamarca Rock/20202512/R/Imagenes/Cajamarca_Rock.png){ width=60% }

```


***
***

## **[2] Artistas**

***
*** 


```{r warning= F, message= F, echo=FALSE, fig.width=5, fig.height=5}
# Playlist Cajamarca Rock: wordcloud 
set.seed(1234)
wordcloud(words = nube$word,
          freq = nube$freq,
          min.freq = 0,
          max.words = 400,
          random.order = T,
          colors = brewer.pal(8, 'Dark2'),
          rot.per = 0.5
          ,use.r.layout = T
          ,scale = c(2.5, 2)
          )
```

Total bandas: `r format(length(cajamarca_rock$BANDA),big.mark = ",")`.

```{r warning= F, message= F, echo=FALSE}
# Playlist Cajamarca Rock

knitr::kable(
  cajamarca_rock %>% select(BANDA, tracks, album)
  ,col.names = c("Artista", "Track", "Album")
  ,caption = "Playlist Cajamarca Rock (Diciembre 2020)\n"
  ,booktabs = TRUE) %>% 
  
  kable_paper(full_width = F, font_size=11.5, position = "left", lightable_options="hover") 
  #kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left", font_size=12)
```


***
***

## **[3] Perfiles**

***
***

### **Seguidores & Popularidad**

<br>

Se muestran datos de los seguidores en spotify de cada artista y se detalla la popularidad de cada banda, la cual se basa en la cantidad de las últimas reproducciones de sus canciones, considerando un valor que está entre 0 y 100, siendo 100 el más popular. 


```{r warning= F, message= F, echo=FALSE, fig.width=10, fig.height=7}
# {.tabset .tabset-fade .tabset-pills}

(seguidores | popularidad)
```

<br>

En el análisis, la banda con mayor popularidad (Hyena) alcanza un valor de 29/100, ubicándose en el primer tercio de la escala de puntos. De igual manera, al observar los datos, la banda con mayor cantidad de seguidores es Hyena (379). 

Se propone un indicador alternativo para medir la popularidad definido como IP. Este se basa en la relación entre las variables obtenidas de los perfiles de cada  artista: popularidad y seguidores (popularity/followers). 

<br>

```{r warning= F, message= F, echo=FALSE}
# Ratio Popularidad / Seguidores

knitr::kable(
  cajamarca_rock_detalleBandas %>% 
  select(name, popularity, followers) %>% 
  mutate(ip = round(ifelse(popularity==0,0,popularity/followers),4)) %>% 
  arrange(desc(ip)) %>% 
  filter(ip > 0) %>% 
  rename(Banda = "name", Popularidad = "popularity", Seguidores = "followers", IP = "ip") %>% 
  head(15)
  #,col.names = c("Rango Score", "Total", "Score Min", "Score Max", "Total %")
  ,caption = "Indicador IP"
  ,booktabs = TRUE
) %>% 
  kable_paper(full_width = F, font_size=11.5, position = "left", lightable_options="hover")
#kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left", font_size=12)

##======= Popularidad Artista <> Popularidad canción
# La popularidad de una canción se calcula mediante un algoritmo y se basa, en su mayor parte, en el número total de reproducciones que ha tenido la pista y qué tan recientes son esas reproducciones.

```

<br>

Bajo este enfoque se puede observar que bandas con pocos seguidores y temas populares pueden generar una métrica mas consistente, como es el caso de Fóbetor que muestra un indicador de 0.3125, siendo el valor más alto en éste análisis. 

<br>

### **Artistas relacionados**

<br>

Se obtiene información sobre artistas similares a un artista determinado. La similitud se basa en el análisis del historial de escucha de la comunidad de Spotify. 

En el siguiente cuadro se muestra a los artistas con los cuales las bandas analizadas tienen mayor relación (Top 10).

```{r warning= F, message= F, echo=FALSE, fig.width=5, fig.height=7}
# Bandas mas relacionadas (top 20)

knitr::kable(
  cajamarca_rock_related %>% 
    group_by(name) %>% 
    summarise(Total = n()) %>% 
    rename(Artista = "name") %>% 
    arrange(desc(Total)) %>% 
    head(10) 
  #,col.names = c("Rango Score", "Total", "Score Min", "Score Max", "Total %")
  # ,caption = ""
  ,booktabs = TRUE
) %>% 
  kable_paper(full_width = F, font_size=11.5, position = "left", lightable_options="hover")
  #kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left", font_size=12)

```

<br>

Bandas de Cajamarca y sus artistas relacionados.

```{r warning= F, message= F, echo=FALSE}
knitr::kable(
  list(relacionados_colapso, relacionados_ratapunks)
  #,col.names = c("Rango Score", "Total", "Score Min", "Score Max", "Total %")
  # ,caption = ""
  #,booktabs = TRUE
  #,align = c('l', 'c', 'c', 'r') # alineamiento de las columnas
  ,format.args = list(big.mark = ',')
  # ,digits = 0 # getOption("digits") # 0
  ) %>%  # Column alignment
  
  kableExtra::kable_styling(bootstrap_options = "striped" # bordered
                            , full_width = T, position = "left", font_size=10.75
                            ) %>% 
  # kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
  
  kable_paper(full_width = F, font_size=11, position = "left", lightable_options="hover") # %>% 
  # column_spec(1, bold = T) %>%
  # column_spec(2, bold = T) %>%
  # column_spec(3, border_right = T) %>%
  
  # kableExtra::kable_styling(position = "left") # bootstrap_options = "striped"


```


```{r warning= F, message= F, echo=FALSE}
knitr::kable(
  list(relacionados_velociraptors, relacionados_perturflacos)
  #,col.names = c("Rango Score", "Total", "Score Min", "Score Max", "Total %")
  #,caption = ""
  #,booktabs = TRUE
  #,align = c('l', 'c', 'c', 'r') # alineamiento de las columnas
  ,format.args = list(big.mark = ',')
  # ,digits = 0 # getOption("digits") # 0
  ) %>%  # Column alignment
  
  kableExtra::kable_styling(bootstrap_options = "striped" # bordered
                            , full_width = T, position = "left", font_size=10.75
                            ) %>% 
  # kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
  
  kable_paper(full_width = F, font_size=11, position = "left", lightable_options="hover") # %>% 
  # column_spec(1, bold = T) %>%
  # column_spec(2, bold = T) %>%
  # column_spec(3, border_right = T) %>%
  
  # kableExtra::kable_styling(position = "left") # bootstrap_options = "striped"

```


```{r warning= F, message= F, echo=FALSE}
knitr::kable(
  list(relacionados_daforest, relacionados_nuevadireccion)
  #,col.names = c("Rango Score", "Total", "Score Min", "Score Max", "Total %")
  #,caption = ""
  #,booktabs = TRUE
  #,align = c('l', 'c', 'c', 'r') # alineamiento de las columnas
  ,format.args = list(big.mark = ',')
  # ,digits = 0 # getOption("digits") # 0
  ) %>%  # Column alignment
  
  kableExtra::kable_styling(bootstrap_options = "striped" # bordered
                            , full_width = T, position = "left", font_size=10.75
                            ) %>% 
  # kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
  
  kable_paper(full_width = F, font_size=11, position = "left", lightable_options="hover") # %>% 
  # column_spec(1, bold = T) %>%
  # column_spec(2, bold = T) %>%
  # column_spec(3, border_right = T) %>%
  
  # kableExtra::kable_styling(position = "left") # bootstrap_options = "striped"

```

<br>

También se realizó un análisis sobre la relación entre las bandas de Cajamarca;  como se esperaba, se muestra una correlación positiva entre las bandas del género rock (Velociraptors, Tour 18-A, Perturflacos, Absenta y Daforest), mientras que la relación es inversa con las bandas ligadas al estilo punk o hardcore (Nueva Dirección y Eterno). 

<br>

```{r warning= F, message= F, echo=FALSE, fig.width=7, fig.height=7}
# Relación entre bandas de Cajamarca -> Relacionados 
corrplot(correlacion_caxa, method = 'color', type = "full"
         ,order="hclust"
         ,addCoef.col = "black" # Add coefficient of correlation
         #,tl.col="black" # Text label color
         ,tl.srt=45  #  Text label rotation | tl.srt = 0.13 -> ejes
         ,tl.cex = 0.7 # size of text label
         ,number.cex = 0.7, number.font = 5 # interior 
         ,title = "\nRelación entre bandas de Cajamarca"
         ) 
```

<br>

### **Producciones musicales**

<br>

A continuación se muestra el detalle de las producciones tales como albums, EPs, singles. 

<br>

```{r warning= F, message= F, echo=FALSE, fig.width=3, fig.height=3, fig.align='center'}
# Producciones
ggplot(producciones
       ,aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=album_type_f)) +
  geom_rect() +
  geom_label( x=3.5, aes(y=labelPosition, label=label), size=4) +
  scale_fill_brewer(type = "seq", palette=4, direction = 1) + # "div", "qual", "seq"
  coord_polar(theta="y") +
  xlim(c(2, 4)) +
  theme_void() +
  theme(legend.position = "none") # + labs(title = "Producciones")
```

<br>

```{r warning= F, message= F, echo=FALSE}
# Tipo de Producciones por Artista 

knitr::kable(
  cajamarca_rock_AlbumInfo %>% 
    group_by(artist) %>% 
    summarise(album = sum(ifelse(album_type_f == 'album', 1, 0))
              ,compilation = sum(ifelse(album_type_f == 'compilation', 1, 0))
              ,ep = sum(ifelse(album_type_f == 'ep', 1, 0))
              ,single = sum(ifelse(album_type_f == 'single', 1, 0))) %>% 
    arrange(desc(album, ep, single, compilation)) # %>% head(20)
  #,col.names = c("Rango Score", "Total", "Score Min", "Score Max", "Total %")
  ,caption = "Tipo de Producciones por Artista"
  ,booktabs = TRUE
  #,align = c('l','c', 'c', 'c') 
) %>%  # Column alignment
  kable_paper(full_width = F, font_size=11.5, position = "left", lightable_options="hover")
#kableExtra::kable_styling(bootstrap_options = "hover", full_width = F, position = "left", font_size=11)

```

<br>

Respecto a las fechas de lanzamiento de las producciones observamos un repunte a partir de 2017. Si bien los albums se han seguido produciendo, los singles son los que presentan la mayor cantidad en estos últimos años. 

<br>

```{r warning= F, message= F, echo=FALSE, fig.width=7, fig.height=5}
## Fecha de Lanzamientos Total

cajamarca_rock_AlbumInfo %>% 
  mutate(lanzamiento = str_sub(release_date, start = 1L, end = 7L)
         ,lanzamiento_anho = year(release_date)) %>% 
  arrange(lanzamiento_anho) %>% 
  group_by(lanzamiento_anho,album_type) %>% 
  summarise(Total = n()) %>% 
  
  ggplot(aes(x=lanzamiento_anho, y=Total, fill=as.factor(lanzamiento_anho))) +
  geom_bar( stat = "identity" ) + 
  scale_fill_viridis(discrete = TRUE) + 
  labs(x = "\nAño"
       ,y= "Total\n"
       ,title = "Fechas de lanzamiento") +
  theme(legend.position="none") 

```


```{r warning= F, message= F, echo=FALSE, fig.width=7, fig.height=5}
## Fecha de Lanzamientos por tipo de producción 

cajamarca_rock_AlbumInfo %>% 
  mutate(lanzamiento = str_sub(release_date, start = 1L, end = 7L)
         ,lanzamiento_anho = year(release_date)) %>% 
  arrange(lanzamiento_anho) %>% 
  group_by(lanzamiento_anho,album_type) %>% 
  summarise(Total = n()) %>% 
  
  ggplot(aes(x=lanzamiento_anho, y=Total, fill=as.factor(lanzamiento_anho))) +
  geom_bar( stat = "identity" ) + 
  #scale_fill_viridis(discrete = TRUE) + 
  labs(x = "\nAño"
       ,y= "Total\n"
       ,title = "Fechas de lanzamiento"
       ,subtitle = "Tipo de Producción") +
  theme(legend.position="none") +
  facet_wrap(~album_type, dir="h") 

```

<br>

Respecto a las canciones, las bandas con mayor cantidad son Nueva Dirección (31), Unidad 4 (26) y Tropel (23).

<br>

```{r warning= F, message= F, echo=FALSE, fig.width=5, fig.height=7}
# Total de canciones por Artista

cajamarca_rock_detalleAlbums_canciones %>% group_by(artist) %>% 
  summarise(total = n()) %>% 
  # arrange(desc(total)) %>% 
  mutate(name = fct_reorder(artist, total)) %>% 
  ggplot(aes(x=name, y=total)) +
  geom_bar(stat = "identity", fill="#f68060", alpha=.6, width=.4) + 
  scale_colour_grey(start = 0.25, end = 0.75) + 
  coord_flip() +
  labs(x = "Artista"
       #,y= "# de canciones"
       ,title = "Total de canciones por Artista")

```

<br>

Analizando la variable popularity (popularidad de las canciones), se observa que  esta se distribuye de manera asimétrica, agrupando valores cercanos a 0 y con un valor promedio de `r round(mean(cajamarca_rock_detalleAlbums_canciones_TopTracks$popularity),2)`.

<br>

```{r warning= F, message= F, echo=FALSE}
# Canciones Populares (total canciones)

cajamarca_rock_detalleAlbums_canciones_TopTracks %>% 
  ggplot(aes(x=popularity)) +
  # geom_histogram() +
  geom_density(fill="#69b3a2", color="#e9ecef", alpha=0.8) +
  labs(title = "Canciones Populares"
       # ,subtitle = "Top Tracks"
       ) +
  theme_ipsum( plot_title_size = 15
              ,axis_text_size = 8
              ,axis_title_size = 7)

```



```{r warning= F, message= F, echo=FALSE}
# Canciones populares por banda Top 10
knitr::kable(
  cajamarca_rock_detalleAlbums_canciones_TopTracks %>% 
  arrange(desc(popularity)) %>% 
  head(10) %>% 
  select(artist, name, popularity)
  #,col.names = c("Rango Score", "Total", "Score Min", "Score Max", "Total %")
  ,caption = "Canciones populares (Top 10)"
  ,booktabs = TRUE
  #,align = c('l','c', 'c', 'c') 
  ) %>%  # Column alignment
  kable_paper(full_width = F, font_size=11.5, position = "left", lightable_options="hover")
  #kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left", font_size=11)


```

<br>

De igual manera, al analizar la variable popularidad de las producciones se aprecia que presenta la misma distribución asimétrica, agrupando valores cercanos a 0 y con un valor promedio de `r round(mean(cajamarca_rock_AlbumInfo$popularity),2)`.

<br>

```{r warning= F, message= F, echo=FALSE}
# Producciones Populares 

cajamarca_rock_AlbumInfo %>% 
  ggplot(aes(x=popularity)) +
  # geom_histogram() +
  geom_density(fill="#83c5d1", color="#e9ecef", alpha=0.8) +
  labs(title = "Producciones Populares"
       # ,subtitle = "Top Tracks"
  ) +
  theme_ipsum( plot_title_size = 15
               ,axis_text_size = 8
               ,axis_title_size = 7)

```

<br>

```{r warning= F, message= F, echo=FALSE}
# Producciones populares (Top 10)

knitr::kable(
  cajamarca_rock_AlbumInfo %>% 
    filter(album_type != 'compilation') %>% 
    select(artist, name, popularity) %>% 
    arrange(desc(popularity)) %>% 
    head(10)
  #,col.names = c("Rango Score", "Total", "Score Min", "Score Max", "Total %")
  ,caption = "Producciones populares (Top 10)"
  ,booktabs = TRUE
  #,align = c('l','c', 'c', 'c') 
  ) %>%  # Column alignment
  kable_paper(full_width = F, font_size=11.5, position = "left", lightable_options="hover")
  #kableExtra::kable_styling(bootstrap_options = "hover", full_width = F, position = "left", font_size=11)


```

<br>
<br>


### **Música**

<br>

```{r warning= F, message= F, echo=FALSE}
# Features Definition 

kbl(features_definicion
    ,caption = "Variables de Audio") %>% 
  kable_paper(full_width = F, font_size=11.5, position = "left", lightable_options="hover") %>% 
  column_spec(1, bold = T, border_right = T) %>%
  column_spec(2, width = "40em")  # , background = "yellow"
  # kableExtra::kable_styling(position = "left") # bootstrap_options = "striped"

```

<br>

Las bandas y tracks en promedio resaltan por su energía, presentan cierta tendencia a la nostalgia o tristeza, carecen de características para ser considerados como "bailables", las pistas en su mayoría son considerados como música por lo que no se puede reconocer adecuadamente contenido vocal o contienen pocas palabras, y por último, los tracks no son considerados temas acústicos.

<br>

```{r warning= F, message= F, echo=FALSE}
# Resumen de indicadores (Tabla 1)

kbl(  features_resumen %>% 
        select(variable, mean, std_dev, p_50) %>% 
        filter(variable %in% c("danceability", "energy", "loudness", "speechiness", "acousticness"
                               ,"instrumentalness", "liveness","valence", "tempo"
                               ,"duration_m")) %>% 
        mutate_if(is.numeric, round, digits=4) %>% 
        rename(Variable = "variable", Promedio = "mean", 'Desviación Estandar' = "std_dev", Mediana = "p_50")
      ,caption = "Variables de Audio (resumen)\n"
      ,booktabs = F) %>% 
  kable_paper(full_width = F, font_size=11.5, position = "left", lightable_options="hover") 

```

<br>

```{r warning= F, message= F, echo=FALSE, fig.width=6, fig.height=5}
# Outliers 

# cajamarca_rock_detalleAlbums_canciones_Features %>% 
#   select_if(colnames(cajamarca_rock_detalleAlbums_canciones_Features) %in% nombres_variables_audio) %>%
#   pivot_longer(cols = nombres_variables_audio) %>% 
#   ggplot() +
#   geom_boxplot(aes(y = value)) + 
#   facet_wrap(~name, nrow = 3, scales = "free") +
#   coord_flip() +
#   ggtitle("Análisis outliers"
#           ,subtitle = "Audio") +
#   theme(axis.text.x = element_text(angle = 50, hjust = 1),axis.text.y = element_blank())


```


```{r warning= F, message= F, echo=FALSE, fig.width=6, fig.height=5}
# <br>
# Distribución

cajamarca_rock_detalleAlbums_canciones_Features %>% 
  select_if(colnames(cajamarca_rock_detalleAlbums_canciones_Features) %in% nombres_variables_audio) %>%
  pivot_longer(cols = nombres_variables_audio) %>% 
  ggplot(aes(x = value)) +
  geom_histogram() +
  facet_wrap(~name, ncol = 3, scales = 'free') +
  #labs(title = 'Distribución de atributos', x = '', y = '') +
  ggtitle("Distribución de atributos"
          ,subtitle = "Audio") +
  theme(axis.text.y = element_blank())

```

<br>

```{r warning= F, message= F, echo=FALSE, fig.width=5, fig.height=3}
# Features Gráfico de Densidad 

# cajamarca_rock_detalleAlbums_canciones_Features %>% 
#   select(
#     danceability, energy
#     #,loudness, mode
#     ,speechiness, acousticness, instrumentalness, liveness
#     ,valence
#     ,tempo
#     ,duration_m
#   ) %>% 
#   ggplot() +
#   geom_density(aes(danceability, fill ="danceability", alpha = 0.1)) + 
#   geom_density(aes(energy, fill ="energy", alpha = 0.1)) + 
#   geom_density(aes(valence, fill ="valence", alpha = 0.1)) + 
#   #geom_density(aes(acousticness, fill ="acousticness", alpha = 0.1)) + 
#   #geom_density(aes(speechiness, fill ="speechiness", alpha = 0.1)) + 
#   #geom_density(aes(liveness, fill ="liveness", alpha = 0.1)) + 
#   #geom_density(aes(liveness, fill ="duration_m", alpha = 0.1)) +
#   scale_x_continuous(name = " ") + # \nEnergy, Danceability, Valence
#   scale_y_continuous(name = "Density\n") +
#   #ggtitle("Gráfico de Densidad") +
#   labs(title = "Features" # Gráfico de Densidad
#        #,subtitle = "Energy, Danceability, Valence"
#   ) +
#   theme_bw() +
#   theme(plot.title = element_text(size = 10, face = "bold"),
#         text = element_text(size = 10)) +
#   theme(legend.title=element_blank()) +
#   scale_fill_brewer(palette="Accent")

```


```{r warning= F, message= F, echo=FALSE}
# Resumen de variables por Artista (valor promedio)

kbl(  features_resumen_banda 
      ,caption = "Resumen de variables por Artista\n"
      ,booktabs = F) %>% 
  kable_paper(full_width = F, font_size=11.5, position = "left", lightable_options="hover") 

```

¿Algunas conclusiones?

+ El artista más bailable: `r (features_resumen_banda %>% 
  filter(danceability == max(features_resumen_banda$danceability)) %>% 
  select(artist))$artist`.
+ El artista con mayor energía: `r (features_resumen_banda %>% 
  filter(energy == max(features_resumen_banda$energy)) %>% 
  select(artist))$artist`. 
+ El artista con mayor volumen (medido en decibelios): `r (features_resumen_banda %>% 
  filter(loudness == max(features_resumen_banda$loudness)) %>% 
  select(artist))$artist`. 
+ El artista que más habla en una canción (palabras y cantidad): `r (features_resumen_banda %>% 
  filter(speechiness == max(features_resumen_banda$speechiness)) %>% 
  select(artist))$artist`.
+ El artista con mejor acústica: `r (features_resumen_banda %>% 
  filter(acousticness == max(features_resumen_banda$acousticness)) %>% 
  select(artist))$artist`.
+ El artista mas instrumental: `r (features_resumen_banda %>% 
  filter(instrumentalness == max(features_resumen_banda$instrumentalness)) %>% 
  select(artist))$artist`.
+ El artista que presenta canciones en vivo: `r (features_resumen_banda %>% 
  filter(liveness == max(features_resumen_banda$liveness)) %>% 
  select(artist))$artist`.
+ El artista más feliz/alegre: `r (features_resumen_banda %>% 
  filter(valence == max(features_resumen_banda$valence)) %>% 
  select(artist))$artist`.

<br>

```{r warning= F, message= F, echo=FALSE, fig.width=5, fig.height=3}
# Duración de las canciones 

cajamarca_rock_detalleAlbums_canciones_Features %>% 
  select(duration_m) %>% 
  
  ggplot() +
  geom_density(aes(duration_m, fill ="duration_m")) + 
  scale_x_continuous(name = "\nduration_m") +
  scale_y_continuous(name = "Density\n") +
  ggtitle("Duración (minutos)") +
  theme_bw() +
  theme(plot.title = element_text(size = 14, face = "bold"),
        text = element_text(size = 11)) +
  theme(legend.title=element_blank()) +
  scale_fill_brewer(palette="RdBu")

```

¿Algunas conclusiones?

+ Duración promedio (minutos): `r round(mean(features_resumen_banda$duration_m),2)`.
+ El artista con las canciones mas cortas: `r (features_resumen_banda %>% 
                                     filter(duration_m == min(features_resumen_banda$duration_m)) %>% 
                                     select(artist))$artist`.
+ El artista con las canciones mas largas: `r (features_resumen_banda %>% 
                                     filter(duration_m == max(features_resumen_banda$duration_m)) %>% 
                                     select(artist))$artist`.


<br>
  
De manera individual se puede observar el detalle de las características de las canciones de acuerdo a sus atributos de audio (danceability, energy, loudness, speechiness, acousticness, instrumentalness, liveness, valence).

<br>
  
```{r warning= F, message= F, echo=FALSE}
# Radar individual

radarchart(radar_encuentro, title = 'El Encuentro Final\n (Fóbetor)'
           #custom polygon
           ,pcol=rgb(0.2,0.5,0.5,0.9) , pfcol=rgb(0.2,0.5,0.5,0.5) , plwd=4
           #custom the grid
           ,cglcol="grey", cglty=1, axislabcol="grey", caxislabels=seq(0,20,5), cglwd=0.8
           #custom labels
           ,vlcex=0.8)


radarchart(radar_lunar, title = 'Lunar\n (Perturflacos)'
           #custom polygon
           ,pcol=rgb(0.2,0.5,0.5,0.9) , pfcol=rgb(0.2,0.5,0.5,0.5) , plwd=4
           #custom the grid
           ,cglcol="grey", cglty=1, axislabcol="grey", caxislabels=seq(0,20,5), cglwd=0.8
           #custom labels
           ,vlcex=0.8)

radarchart(radar_temblores, title = 'Temblores\n (Daforest)'
           #custom polygon
           ,pcol=rgb(0.2,0.5,0.5,0.9) , pfcol=rgb(0.2,0.5,0.5,0.5) , plwd=4
           #custom the grid
           ,cglcol="grey", cglty=1, axislabcol="grey", caxislabels=seq(0,20,5), cglwd=0.8
           #custom labels
           ,vlcex=0.8)

radarchart(radar_nubes, title = 'Nubes\n (Velociraptors)'
           #custom polygon
           ,pcol=rgb(0.2,0.5,0.5,0.9) , pfcol=rgb(0.2,0.5,0.5,0.5) , plwd=4
           #custom the grid
           ,cglcol="grey", cglty=1, axislabcol="grey", caxislabels=seq(0,20,5), cglwd=0.8
           #custom labels
           ,vlcex=0.8)

radarchart(radar_demonios, title = 'Demonios\n (Absenta)'
           #custom polygon
           ,pcol=rgb(0.2,0.5,0.5,0.9) , pfcol=rgb(0.2,0.5,0.5,0.5) , plwd=4
           #custom the grid
           ,cglcol="grey", cglty=1, axislabcol="grey", caxislabels=seq(0,20,5), cglwd=0.8
           #custom labels
           ,vlcex=0.8)

radarchart(radar_ladrones, title = 'Los Ladrones\n (Las Ratapunks)'
           #custom polygon
           ,pcol=rgb(0.2,0.5,0.5,0.9) , pfcol=rgb(0.2,0.5,0.5,0.5) , plwd=4
           #custom the grid
           ,cglcol="grey", cglty=1, axislabcol="grey", caxislabels=seq(0,20,5), cglwd=0.8
           #custom labels
           ,vlcex=0.8)

```

Se muestra también, de manera conjunta, las características del top de canciones populares. 

```{r warning= F, message= F, echo=FALSE, fig.width=6, fig.height=5}
# Radar agrupado

ggradar(variables %>% 
          filter(name %in% nombres_tracks_populares_top5 & album_type_f!='single'
                 | (name == 'Los Ladrones' & album == 'Fracaso, Año de la Rata 2020')
          ) %>% 
          select(name, one_of(nombres_variables_audio), -duration_m, -loudness)
        #,base.size = 5
        ,grid.label.size = 3.1 # %
        ,axis.label.size = 3.5 # variables
        ,group.line.width = 1.3 # línea del radar
        ,group.point.size = 3 # punto del radar 
        ,legend.title = ""
        ,plot.title = "" # Canciones populares (Top 5)
        ,legend.text.size = 10
        ,legend.position = "bottom")

```


<br>

### **Bandas**

<br>

```{r warning= F, message= F, echo=FALSE, fig.width=6, fig.height=5}
# Distribución

variables %>% 
  rename(explicit = "explicit_f") %>% 
  select(one_of(nombres_variables_banda), -track_total) %>%
  pivot_longer(cols = nombres_variables_banda[-6]) %>% 
  mutate( name2 =  ifelse(name == "popularity_banda", "popularidad_banda"
                  ,ifelse(name == "popularity_track", "popularidad_track", name))) %>% 
  select(name2, value) %>% 
  ggplot(aes(x = value)) +
  geom_histogram() +
  facet_wrap(~name2, ncol = 3, scales = 'free') +
  #labs(title = 'Distribución de atributos', x = '', y = '') +
  ggtitle("Distribución de atributos"
          ,subtitle = "Artista") +
  theme(axis.text.y = element_blank())

```


¿Algunas conclusiones?

+ Banda con la producción mas antigua: `r (variables %>% 
  filter(antiguedad_produccion == max(variables$antiguedad_produccion)) %>% 
  head(1) %>% 
  select(artist))$artist`.
+ Artista con letras explicitas: `r (variables %>% 
    filter(explicit_f == max(variables$explicit_f)) %>% 
    arrange(desc(popularity_track)) %>% 
    select(artist, name, explicit_f, popularity_track) %>% 
    head(1) %>% 
    select(artist))$artist`.
+ Banda con mas seguidores: `r (variables %>% 
  filter(followers_banda == max(variables$followers_banda)) %>% 
  head(1) %>% 
  select(artist))$artist`.
+ Banda con mayor popularidad: `r (variables %>% 
  filter(popularity_banda == max(variables$popularity_banda)) %>% 
  head(1) %>% 
  select(artist))$artist`.
+ Producción mas popular: `r paste0(
  (variables %>% 
      filter(popularidad_produccion == max(variables$popularidad_produccion)) %>% 
      head(1) %>% 
      select(album))$album
  ," ("
  ,(variables %>% 
      filter(popularidad_produccion == max(variables$popularidad_produccion)) %>% 
      head(1) %>% 
      select(artist))$artist
  ,")")`.
+ Track mas popular: `r paste0(
  (variables %>% 
          filter(popularity_track == max(variables$popularity_track)) %>% 
          select(name))$name
  ," ("
  ,(variables %>% 
      filter(popularity_track == max(variables$popularity_track)) %>% 
                                        select(artist))$artist
  ,")")`.
  


<br>
<br>

***
***

## **[4] Music Analytics**

***
***


El objetivo es encontrar características comunes sobre el total de variables. Se identifican elementos similares dentro del conjunto de datos de forma que las observaciones que están dentro de un mismo grupo sean parecidas entre sí y a la vez distintas a las observaciones de otros grupos. 

<br>

### **Variables de Audio**

<br>

Las variables (o atributos) de audio de las canciones llegan a ser importantes para cada banda; si bien no existe una regla para clasificar una canción o artista, estas variables nos permiten aproximarnos al sonido de cada agrupación. 

Se aplica un algoritmo de machine learning para identificar segmentos a los cuales podría pertenecer cada track. 

<br>

```{r warning= F, message= F, echo=FALSE, fig.width=7, fig.height=5}
# {.tabset .tabset-fade .tabset-pills}

# Segmentación

# grid.arrange(p2, p3, p4, p5, nrow = 2)

grid.arrange(p2_audio, p3_audio, p4_audio, p5_audio
             ,nrow = 2
             ,top = textGrob("Segmentación: Variables de audio\n"
                             ,gp=gpar(fontsize=14,font=0.6)))

```

<br>

De manera gráfica observamos que el algoritmo identifica los segmentos con características comunes. En nuestro caso, y para evidenciar las diferencias entre estas agrupaciones, consideramos 3 grupos (k=3). 

<br>

```{r warning= F, message= F, echo=FALSE}
# Interpretamos los clusters
# , cols.print=9, rows.print=10, pages.print=2

kbl(
  left_join(variables %>% rename(explicit="explicit_f") %>% 
              select(one_of(nombres_variables_audio), cluster_audio) %>% 
              group_by(cluster_audio) %>% 
              summarise_all("mean")
            ,variables %>% 
              group_by(cluster_audio) %>% 
              summarise( total_canciones = n() 
                         #,total_bandas = n_distinct(artist, na.rm = FALSE)  
              )
            ,by = "cluster_audio")
  ,caption = "Segmentos: Audio\n"
  ,booktabs = T) %>% 
  kable_paper(full_width = F, font_size=11.5, position = "left", lightable_options="hover") %>%
  scroll_box(width = "100%") # height = "400px"


```

<br>

Para determinar las características que predominan en los segmentos aplicamos un algoritmo basado en árboles de decisión debido a su facilidad de interpretación. En este caso, el segmento 1 lo conforman aquellas bandas con un speechiness menor a 0.079 y una acústica mayor o igual a 0.058, mientras que al segmento 2 corresponden las agrupaciones con un speechiness menor a 0.079 y una acústica menor a 0.058. Por último, el segmento 3 queda claramente definido por las bandas que poseen un speechiness mayor o igual a 0.079. 

```{r warning= F, message= F, echo=FALSE, fig.width=7, fig.height=5}
# Explicamos los clusters

rpart.plot(modelo_segmentos_audio, 
           type = 5, 
           extra = 104,
           box.palette = list(purple = "#490B32",
                              red = "#9A031E",
                              orange = '#FB8B24',
                              dark_blue = "#0F4C5C",
                              blue = "#5DA9E9",
                              grey = '#66717E'),
           leaf.round = 0,
           fallen.leaves = FALSE, 
           branch = 0.2, 
           under = TRUE,
           under.col = 'grey40',
           family = 'Avenir',
           main = 'Características de los segmentos',
           tweak = 1.2
           ,cex=0.6
           ,roundint=FALSE
)

```


```{r warning= F, message= F, echo=FALSE, fig.width=7, fig.height=5}
# Explicamos los clusters: Reglas

# rpart.rules(modelo_segmentos_audio) 


```

<br>

Al obtener aleatoriamente tres bandas de cada segmento podemos comparar sus características. Así por ejemplo, el segmento 1 lo conforman las bandas con una energía baja (0.63 a 84), al segmento 2 pertenecen las bandas con una energía media (0.91 a 0.93), y el segmento 3 incluye las bandas con mayor energía (0.97 a 0.98). 

<br>

```{r warning= F, message= F, echo=FALSE}
# Top 3 de cada segmento

kbl(union(
  variables %>% rename(explicit="explicit_f") %>% 
    filter(cluster_audio==1) %>% # artist %in% bandas_cluster_audio1 
    group_by(cluster_audio, artist) %>% summarise_all("mean") %>% 
    select(artist,cluster_audio,one_of(nombres_variables_audio)) %>% 
    arrange(cluster_audio, desc(energy)) %>% 
    head(3)
  ,variables %>% rename(explicit="explicit_f") %>% 
    filter(cluster_audio==2) %>% # artist %in% bandas_cluster_audio2 
    group_by(cluster_audio, artist) %>% summarise_all("mean") %>% 
    select(artist,cluster_audio,one_of(nombres_variables_audio)) %>% 
    arrange(cluster_audio, desc(energy)) %>% 
    head(3)) %>% 
    union(
      variables %>% rename(explicit="explicit_f") %>% 
        filter(cluster_audio==3) %>% # artist %in% bandas_cluster_audio2 
        group_by(cluster_audio, artist) %>% summarise_all("mean") %>% 
        select(artist,cluster_audio,one_of(nombres_variables_audio)) %>% 
        arrange(cluster_audio, desc(energy)) %>% 
        head(3)
    )
  ,caption = "Bandas (top 3 de cada segmento)\n"
  ,booktabs = T) %>% 
  
  kable_paper(full_width = F, font_size=11.5, position = "left", lightable_options="hover") # %>% scroll_box(width = "100%", height = "400px")

```


<br>
<br>


### **Variables del Artista**

<br>

Las variables de los artistas están conformadas por las características no musicales de la banda tales como antigüedad de sus producciones, popularidad, seguidores, total de canciones, entre otros. 

<br>

```{r warning= F, message= F, echo=FALSE, fig.width=7, fig.height=5}
# Segmentación

# grid.arrange(p2, p3, p4, p5, nrow = 2)

grid.arrange(p2_banda, p3_banda, p4_banda, p5_banda
             ,nrow = 2
             ,top = textGrob("Segmentación: Variables del artista\n"
                             ,gp=gpar(fontsize=14,font=0.6)))

```

<br>

En este caso el algoritmo nos sugiere 2 segmentos (k=2). Para determinar las diferencias entre ellos, evaluamos la variable popularidad, observando que en promedio las bandas que conforman el segmento 1 son menos populares que el segmento 2 (1.02 < 5.44).

<br>

```{r warning= F, message= F, echo=FALSE}
# Interpretamos los clusters
# , cols.print=9, rows.print=10, pages.print=2

kbl(
  left_join(variables %>% rename(explicit="explicit_f") %>% 
              select(one_of(nombres_variables_banda), cluster_banda) %>% 
              group_by(cluster_banda) %>% 
              summarise_all("mean")
            ,variables %>% 
              group_by(cluster_banda) %>% 
              summarise( total_canciones = n() 
                         #,total_bandas = n_distinct(artist, na.rm = FALSE)  
              )
            ,by = "cluster_banda")
  ,caption = "Segmentos: Artistas\n"
  ,booktabs = T) %>% 
  kable_paper(full_width = F, font_size=11.5, position = "left", lightable_options="hover") %>% 
  scroll_box(width = "100%") # , height = "400px"


```

<br>

En este tipo de datos, los atributos predominantes se refieren a la popularidad de las canciones así como a la cantidad de seguidores de la banda los cuales diferencian aceptablemente ambos segmentos. 
  
```{r warning= F, message= F, echo=FALSE, fig.width=7, fig.height=5}
# Explicamos los clusters

rpart.plot(modelo_segmentos_banda, 
           type = 5, 
           extra = 104,
           box.palette = list(purple = "#490B32",
                              red = "#9A031E",
                              orange = '#FB8B24',
                              dark_blue = "#0F4C5C",
                              blue = "#5DA9E9",
                              grey = '#66717E'),
           leaf.round = 0,
           fallen.leaves = FALSE, 
           branch = 0.2, 
           under = TRUE,
           under.col = 'grey40',
           family = 'Avenir',
           main = 'Características de los segmentos',
           tweak = 1.2
           ,cex=0.5
           ,roundint=FALSE
)

```


```{r warning= F, message= F, echo=FALSE, fig.width=7, fig.height=5}
# Explicamos los clusters: Reglas

# rpart.rules(modelo_segmentos_banda)


```

<br>

Obteniendo aleatoriamente cinco bandas de cada grupo, y analizando la cantidad de seguidores, vemos una clara diferencia entre ambos segmentos, pues las bandas del segmento 1 presentan menos seguidores (56 a 138) en comparación a las bandas del segmento 2 (233 a 379).

<br>

```{r warning= F, message= F, echo=FALSE}
# Top 5 de cada segmento


kbl(union(
  variables %>% rename(explicit="explicit_f") %>% 
    filter(cluster_banda==1) %>% # artist %in% bandas_cluster_banda1 
    group_by(cluster_banda, artist) %>% summarise_all("mean") %>% 
    select(artist,cluster_banda,one_of(nombres_variables_banda)) %>% 
    arrange(cluster_banda, desc(followers_banda)) %>% 
    head(5)
  ,variables %>% rename(explicit="explicit_f") %>% 
    filter(cluster_banda==2) %>% # artist %in% bandas_cluster_banda2 
    group_by(cluster_banda, artist) %>% summarise_all("mean") %>% 
    select(artist,cluster_banda,one_of(nombres_variables_banda)) %>% 
    arrange(cluster_banda, desc(followers_banda)) %>% 
    head(5))
  
  # %>% 
  #   union(
  #     variables %>% rename(explicit="explicit_f") %>% 
  #       filter(cluster_banda==3) %>% # artist %in% bandas_cluster_banda2 
  #       group_by(cluster_banda, artist) %>% 
  #       select(artist,cluster_banda,one_of(nombres_variables_banda)) %>% 
  #       summarise_all("mean") %>% 
  #       arrange(cluster_banda, desc(followers_banda)) %>% 
  #       head(3)
  # )
  ,caption = "Bandas (top 5 de cada segmento)\n"
  ,booktabs = T) %>% 
  
  kable_paper(full_width = F, font_size=11.5, position = "left", lightable_options="hover") # %>% scroll_box(width = "100%") # , height = "400px"

```


<br>
<br>


```{r warning= F, message= F, echo=FALSE}


# ***
# ***
# 
# ## **[5] Gustos y Preferencias**
# 
# ***
# ***
# 
# Preguntas: 
# + ¿Que canción puede llegar a ser popular?
# + ¿Que características tienen las canciones populares?
# 
# 
# Un sistema de recomendación para los oyentes en base a sus gustos y preferencias. 

```



```{r warning= F, message= F, echo=FALSE}
# Generamos una playlist con las mejores canciones de las bandas.

```




```{r warning= F, message= F, echo=FALSE}

```



```{r warning= F, message= F, echo=FALSE, fig.width=6, fig.height=4}

```


```{r warning= F, message= F, echo=FALSE}

# ***
# ***
# 
# ## **[6] Gustos y Preferencias**
# 
# ***
# ***
# 
#   

```



```{r warning= F, message= F, echo=FALSE}

```




```{r warning= F, message= F, echo=FALSE, fig.width=6, fig.height=4}



```


***
***

## **[5] Conclusiones**

***
***

  1. El análisis inicia con `r format(length(cajamarca_rock$BANDA),big.mark = ",")` bandas, pero a la fecha de esta publicación no se pudo ubicar en Spotify a CAN, Hyena, Corazones Niños, Batecaña, Irrational, Yugo y Latemckor. Entre las bandas ausentes en esta plataforma se mencionan a Ruido Negro, Los Kaliches, Karikatumba, entre otras. 
  2. Existen limitaciones para el análisis, por ejemplo bandas homónimas y registro de datos incompletos. 
  3. De manera general la banda con mayor cantidad de seguidores y popularidad es Hyena. 
  4. Se plantea un indicador de popularidad alternativo (IP) para analizar la relación entre la popularidad y la cantidad de seguidores. Bajo este enfoque se puede observar que bandas con pocos seguidores y temas populares pueden generar una métrica más consistente. 
  5. Las bandas con mayor cantidad de canciones son Nueva Dirección (31), Unidad 4 (26) y Tropel (23). 
  6. El número de producciones entre albums, EPs y singles es muy similar. No obstante, en los útlimos años hay mayor producción de singles; esto se puede explicar debido a algunos factores como la diferencia de costos o el tiempo que  necesita cada producción. 
  7. Hasta la fecha las producciones más populares son Blisters (Velociraptors), Juegos Peligrosos (Fóbetor) y Espejismos (Da Forest). 
  8. De acuerdo a los atributos analizados, musicalmente las producciones de las bandas resaltan por su energía (energy), presentan cierta tendencia a la nostalgia o tristeza (valence), carecen de características para ser considerados como "bailables" (danceability), las pistas en su mayoría son considerados como música por lo que no se puede reconocer adecuadamente contenido vocal o contienen pocas palabras (instrumentalness & speechiness), y por último, los tracks no son considerados temas acústicos (acousticness). 
  9. Las segmentaciones propuestas son aceptables, pues permiten clasificar las bandas en grupos más pequeños que comparten caraceterísticas comunes alrededor de su música, seguidores, producciones y popularidad. 
  
<br>
<br>  

***
***

## **[6] Créditos**

***
***

Elaborado por **Alan Grosso** para **DFT Support**.

<alangrosso@gmail.com> | [Instagram](https://www.instagram.com/alangrosso) |  [LinkedIn](https://www.linkedin.com/in/alangrosso)

Corrección de estilo por **Kiara Lozano**.

<kiaralozanonu@gmail.com> 

<br>
<br>

***
***

## **[7] Contacto**

***
***

**DFT Support**

[Facebook](https://www.facebook.com/dieforthis) | [Instagram](https://www.instagram.com/dieforthis_/) |  [YouTube](https://www.youtube.com/dieforthisvideos/)

**Playlist** 

[Cajamarca Rock](https://open.spotify.com/playlist/0NEpA7QS9DDRHa3JsAtdcd?si=da2c37c0d7ea4dcd) 

<br>
<br>